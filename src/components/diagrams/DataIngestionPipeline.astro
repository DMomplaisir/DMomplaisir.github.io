---
/**
 * Data Ingestion Pipeline Diagram
 * Animated flow visualization for RefIndex project
 *
 * Shows: Multiple Sources → Reconciliation → Enrichment → Video Fetching → Ready for Evaluation
 */

interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<div class:list={["pipeline-container", className]} data-pipeline="ingestion">
  <!-- Multiple sources feeding in -->
  <div class="sources-section">
    <div class="source-label">Data Sources</div>
    <div class="source-nodes">
      <div class="source-node" data-source="1">
        <div class="source-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M3 9h18M9 21V9"/>
          </svg>
        </div>
        <span class="source-text">Source A</span>
      </div>
      <div class="source-node" data-source="2">
        <div class="source-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="9"/>
            <path d="M12 3v9l4 4"/>
          </svg>
        </div>
        <span class="source-text">Source B</span>
      </div>
      <div class="source-node" data-source="3">
        <div class="source-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c-1.657 0-3-4.03-3-9s1.343-9 3-9m0 18c1.657 0 3-4.03 3-9s-1.343-9-3-9m-9 9a9 9 0 019-9"/>
          </svg>
        </div>
        <span class="source-text">Source C</span>
      </div>
    </div>

    <!-- Converging lines -->
    <div class="convergence-lines">
      <svg viewBox="0 0 120 60" preserveAspectRatio="none">
        <path class="converge-path" d="M0,10 Q60,10 100,30" />
        <path class="converge-path" d="M0,30 L100,30" />
        <path class="converge-path" d="M0,50 Q60,50 100,30" />
        <circle class="flow-particle" r="3" />
        <circle class="flow-particle" r="3" />
        <circle class="flow-particle" r="3" />
      </svg>
    </div>
  </div>

  <!-- Main pipeline track -->
  <div class="pipeline-track">
    <!-- Stage 1: Reconciliation -->
    <div class="pipeline-stage" data-stage="1">
      <div class="stage-node">
        <div class="node-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
          </svg>
        </div>
        <span class="node-label">Reconciliation</span>
        <span class="node-detail">Alias matching</span>
      </div>
      <div class="flow-line">
        <div class="flow-dot"></div>
      </div>
    </div>

    <!-- Stage 2: Deduplication -->
    <div class="pipeline-stage" data-stage="2">
      <div class="stage-node">
        <div class="node-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
            <path d="M14 14h7v7"/>
            <path d="M17 17l4 4"/>
          </svg>
        </div>
        <span class="node-label">Dedupe</span>
        <span class="node-detail">Game + referee IDs</span>
      </div>
      <div class="flow-line">
        <div class="flow-dot"></div>
      </div>
    </div>

    <!-- Stage 3: Enrichment -->
    <div class="pipeline-stage" data-stage="3">
      <div class="stage-node highlight">
        <div class="node-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
          </svg>
        </div>
        <span class="node-label">Enrichment</span>
        <span class="node-detail">Play-by-play</span>
      </div>
      <div class="flow-line">
        <div class="flow-dot"></div>
      </div>
    </div>

    <!-- Stage 4: Video Fetching -->
    <div class="pipeline-stage" data-stage="4">
      <div class="stage-node">
        <div class="node-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <polygon points="5 3 19 12 5 21 5 3"/>
          </svg>
        </div>
        <span class="node-label">Video Fetch</span>
        <span class="node-detail">Event clips</span>
      </div>
      <div class="flow-line">
        <div class="flow-dot"></div>
      </div>
    </div>

    <!-- Stage 5: Ready -->
    <div class="pipeline-stage" data-stage="5">
      <div class="stage-node endpoint">
        <div class="node-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <span class="node-label">Ready</span>
        <span class="node-detail">Same-night</span>
      </div>
    </div>
  </div>

  <!-- Batch indicator -->
  <div class="batch-indicator">
    <span class="batch-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="14" height="14">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 6v6l4 2"/>
      </svg>
    </span>
    <span class="batch-text">Runs nightly · 30+ games</span>
  </div>

  <!-- Progress indicator -->
  <div class="pipeline-progress">
    <div class="progress-bar"></div>
  </div>
</div>

<style>
  .pipeline-container {
    --pipeline-color: var(--blueprint-blue);
    --pipeline-bg: var(--blueprint-blue-faint);
    --pipeline-line: var(--blueprint-line);
    --node-size: 52px;

    width: 100%;
    padding: var(--space-lg) 0;
    margin: var(--space-lg) 0;
    background: var(--pipeline-bg);
    border-radius: var(--radius-lg);
    border: 1px solid var(--pipeline-line);
    overflow: hidden;
    position: relative;
  }

  /* Sources Section */
  .sources-section {
    display: flex;
    align-items: center;
    padding: 0 var(--space-lg);
    margin-bottom: var(--space-md);
    gap: var(--space-sm);
  }

  .source-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    writing-mode: vertical-lr;
    transform: rotate(180deg);
  }

  .source-nodes {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .source-node {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    opacity: 0;
    transform: translateX(-12px);
    animation: sourceReveal 0.4s var(--ease-out) forwards;
  }

  .source-node[data-source="1"] { animation-delay: 0.1s; }
  .source-node[data-source="2"] { animation-delay: 0.2s; }
  .source-node[data-source="3"] { animation-delay: 0.3s; }

  @keyframes sourceReveal {
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .source-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--warm-white);
    border: 1px solid var(--pipeline-line);
    border-radius: var(--radius-base);
    color: var(--pipeline-color);
  }

  .source-icon svg {
    width: 16px;
    height: 16px;
  }

  .source-text {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-secondary);
  }

  /* Convergence lines SVG */
  .convergence-lines {
    width: 60px;
    height: 60px;
    flex-shrink: 0;
  }

  .convergence-lines svg {
    width: 100%;
    height: 100%;
  }

  .converge-path {
    fill: none;
    stroke: var(--pipeline-line);
    stroke-width: 1.5;
  }

  .flow-particle {
    fill: var(--pipeline-color);
    opacity: 0;
  }

  .flow-particle:nth-child(4) {
    animation: particleFlow1 2.5s var(--ease-in-out) infinite;
  }
  .flow-particle:nth-child(5) {
    animation: particleFlow2 2.5s var(--ease-in-out) infinite 0.3s;
  }
  .flow-particle:nth-child(6) {
    animation: particleFlow3 2.5s var(--ease-in-out) infinite 0.6s;
  }

  @keyframes particleFlow1 {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
  }

  @keyframes particleFlow2 {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
  }

  @keyframes particleFlow3 {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
  }

  /* Pipeline Track */
  .pipeline-track {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 0 var(--space-lg);
    gap: var(--space-xs);
  }

  .pipeline-stage {
    display: flex;
    align-items: center;
    flex: 1;
    opacity: 0;
    transform: translateY(8px);
    animation: stageReveal 0.5s var(--ease-out) forwards;
  }

  .pipeline-stage[data-stage="1"] { animation-delay: 0.4s; }
  .pipeline-stage[data-stage="2"] { animation-delay: 0.55s; }
  .pipeline-stage[data-stage="3"] { animation-delay: 0.7s; }
  .pipeline-stage[data-stage="4"] { animation-delay: 0.85s; }
  .pipeline-stage[data-stage="5"] { animation-delay: 1s; }

  @keyframes stageReveal {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .stage-node {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    min-width: var(--node-size);
  }

  .node-icon {
    width: var(--node-size);
    height: var(--node-size);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--warm-white);
    border: 2px solid var(--pipeline-color);
    border-radius: var(--radius-lg);
    color: var(--pipeline-color);
    transition: all var(--transition-base);
  }

  .node-icon svg {
    width: 22px;
    height: 22px;
  }

  .stage-node.highlight .node-icon {
    background: var(--burgundy-primary);
    border-color: var(--burgundy-primary);
    color: var(--warm-white);
    box-shadow: var(--shadow-burgundy);
  }

  .stage-node.endpoint .node-icon {
    background: var(--success-green);
    border-color: var(--success-green);
    color: var(--warm-white);
  }

  .node-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    color: var(--text-primary);
    text-align: center;
    white-space: nowrap;
  }

  .node-detail {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-secondary);
    text-align: center;
    white-space: nowrap;
  }

  /* Flow lines */
  .flow-line {
    flex: 1;
    height: 2px;
    background: var(--pipeline-line);
    margin: 0 var(--space-xs);
    margin-top: calc(var(--node-size) / 2);
    position: relative;
    min-width: 16px;
  }

  .flow-dot {
    position: absolute;
    width: 6px;
    height: 6px;
    background: var(--pipeline-color);
    border-radius: 50%;
    top: 50%;
    left: 0;
    transform: translate(-50%, -50%);
    opacity: 0;
    animation: flowPulse 2.5s var(--ease-in-out) infinite;
  }

  .pipeline-stage[data-stage="1"] .flow-dot { animation-delay: 0.5s; }
  .pipeline-stage[data-stage="2"] .flow-dot { animation-delay: 1s; }
  .pipeline-stage[data-stage="3"] .flow-dot { animation-delay: 1.5s; }
  .pipeline-stage[data-stage="4"] .flow-dot { animation-delay: 2s; }

  @keyframes flowPulse {
    0% { left: 0; opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { left: 100%; opacity: 0; }
  }

  /* Batch indicator */
  .batch-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xs);
    margin-top: var(--space-md);
    padding-top: var(--space-sm);
    border-top: 1px dashed var(--pipeline-line);
    margin-left: var(--space-lg);
    margin-right: var(--space-lg);
  }

  .batch-icon {
    color: var(--pipeline-color);
    display: flex;
  }

  .batch-text {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--text-secondary);
  }

  /* Progress bar */
  .pipeline-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--pipeline-line);
  }

  .progress-bar {
    height: 100%;
    width: 0;
    background: linear-gradient(90deg, var(--pipeline-color), var(--burgundy-primary));
    animation: progressFill 2.5s var(--ease-out) infinite;
  }

  @keyframes progressFill {
    0% { width: 0; }
    100% { width: 100%; }
  }

  /* Responsive */
  @media (max-width: 900px) {
    .sources-section {
      flex-direction: column;
      align-items: flex-start;
    }

    .source-label {
      writing-mode: horizontal-tb;
      transform: none;
      margin-bottom: var(--space-xs);
    }

    .source-nodes {
      flex-direction: row;
      flex-wrap: wrap;
    }

    .convergence-lines {
      display: none;
    }
  }

  @media (max-width: 768px) {
    .pipeline-track {
      flex-direction: column;
      align-items: stretch;
      gap: var(--space-sm);
    }

    .pipeline-stage {
      flex-direction: row;
    }

    .stage-node {
      flex-direction: row;
      gap: var(--space-sm);
      min-width: auto;
    }

    .flow-line {
      width: 2px;
      height: 20px;
      min-width: 2px;
      margin: var(--space-xs) 0;
      margin-left: calc(var(--node-size) / 2);
    }

    .flow-dot {
      animation-name: flowPulseVertical;
    }

    @keyframes flowPulseVertical {
      0% { top: 0; left: 50%; opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { top: 100%; left: 50%; opacity: 0; }
    }

    .node-detail {
      display: none;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .pipeline-stage,
    .source-node {
      opacity: 1;
      transform: none;
      animation: none;
    }

    .flow-dot,
    .flow-particle {
      animation: none;
      opacity: 0.5;
    }

    .flow-dot {
      left: 50%;
    }

    .progress-bar {
      animation: none;
      width: 100%;
    }
  }

  /* Dark mode */
  @media (prefers-color-scheme: dark) {
    .pipeline-container {
      --pipeline-bg: rgba(14, 165, 233, 0.08);
      --pipeline-line: rgba(14, 165, 233, 0.2);
    }

    .node-icon,
    .source-icon {
      background: var(--concrete-900);
    }

    .node-label {
      color: var(--warm-white);
    }
  }
</style>
